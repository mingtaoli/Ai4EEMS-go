
# 02 数据库启动：PostgreSQL 核心服务部署文档

本阶段的目标是启动 PostgreSQL 数据库服务，并利用 Docker 机制，自动完成系统核心表的创建和初始数据的导入，为后续 Go-Zero 服务的用户登录功能提供数据基础。

### 部署所需的三个核心文件

要成功启动和初始化数据库，我们需要三个关键文件，它们都位于或与 `deploy/` 目录相关：

1.  **`ai4eems.env`**: 环境变量文件，安全地存储数据库连接信息。
2.  **`ai4eemsdb.sql`**: 数据库初始化脚本，包含精简后的表结构和数据。
3.  **`docker-compose.yaml`**: 编排文件，定义 `postgres` 服务的配置和挂载。

-----

## 1\. 配置文件（`ai4eems.env`）

这个文件用于定义 PostgreSQL 的用户名、密码和数据库名称，确保敏感信息与 `docker-compose.yaml` 文件分离。

**保存路径：** `deploy/ai4eems.env`

```
# postgresql 数据库配置
PG_USER=ai4eemsuser
PG_PASSWORD=124356987
PG_DATABASE=ai4eemsdb
```

-----

## 2\. 数据库初始化 SQL 文件（`ai4eemsdb.sql`）

### 来源与提取过程（为教学准备）

为了快速拥有一个能支撑登录的数据库，我们没有从零开始设计表结构，而是借鉴了成熟的微服务系统 **YUDAO** 的数据库设计。

**我们的提取过程如下：**

1.  **确定目标：** 我们的最小可用系统只需要**用户登录和权限验证**功能。
2.  **锁定模块：** 在 YUDAO 的原始 SQL 文件中，我们只关注 **`system`** 模块相关的表。
3.  **精简骨架：** 从原始复杂的表中，我们只提取了三个核心表结构：
      * `system_user` (用户表)：存储登录账号、密码。
      * `system_role` (角色表)：存储权限组信息，如“管理员”。
      * `system_user_role` (用户角色关联表)：连接用户和角色，赋予权限。
4.  **注入最小数据：** 。

**保存路径：** `deploy/ai4eemsdb.sql`

```sql
-- ai4eemsdb.sql
-- 目标：从 YUDAO-Cloud-Mini 简化提取的最小系统模块初始化脚本

-- 1. Table: system_user (用户表)
CREATE TABLE IF NOT EXISTS system_user (
    id BIGINT PRIMARY KEY,
    username VARCHAR(64) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    nickname VARCHAR(64) NOT NULL,
    email VARCHAR(128),
    phone_number VARCHAR(11),
    status SMALLINT NOT NULL DEFAULT 0, -- 0: 正常, 1: 禁用
    dept_id BIGINT,
    creator VARCHAR(64),
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 2. Table: system_role (角色表)
CREATE TABLE IF NOT EXISTS system_role (
    id BIGINT PRIMARY KEY,
    name VARCHAR(30) NOT NULL UNIQUE,
    code VARCHAR(100) NOT NULL UNIQUE,
    sort SMALLINT,
    status SMALLINT NOT NULL DEFAULT 0, -- 0: 正常, 1: 禁用
    creator VARCHAR(64),
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 3. Table: system_user_role (用户角色关联表)
CREATE TABLE IF NOT EXISTS system_user_role (
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    PRIMARY KEY (user_id, role_id)
);

-- 4. Initial Data: Roles (初始化角色数据)
INSERT INTO system_role (id, name, code, sort, status) VALUES
(1, '超级管理员', 'admin', 1, 0) ON CONFLICT (id) DO NOTHING;

-- 5. Initial Data: User (初始化管理员用户数据)
-- 密码 'admin' 的示例加密哈希。
INSERT INTO system_user (id, username, password, nickname, email, status) VALUES
(1, 'admin', '$2a$10$o8.jQWq/c.o3.j.T/8sOQ.g3qK8.Hl.dJ/s/k.t.y.L', '管理员', 'admin@ai4eems.com', 0) ON CONFLICT (id) DO NOTHING;

-- 6. Link User and Role (关联用户和角色)
INSERT INTO system_user_role (user_id, role_id) VALUES
(1, 1) ON CONFLICT (user_id, role_id) DO NOTHING;
```

-----

## 3\. Docker Compose 服务定义（`postgres` 服务）

这部分定义了如何在 Docker 环境中启动 PostgreSQL 实例，并与上面两个文件协同工作。

**请将以下片段添加到 `deploy/docker-compose.yaml` 文件的 `services:` 部分。**

```yaml
  postgres:
    image: postgres:16-alpine
    container_name: ai4eems-postgres
    env_file:
      - ai4eems.env # 导入自定义环境变量
    restart: always
    volumes:
      - ./postgres-data:/var/lib/postgresql/data # 数据持久化：重要！确保数据不会丢失。
      - ./ai4eemsdb.sql:/docker-entrypoint-initdb.d/ai4eemsdb.sql:ro # 数据库初始化：在第一次启动时执行 SQL 脚本。
    expose:
      - "5432" # 内部暴露给 Go-Zero 服务使用
    environment:
      POSTGRES_DB: ${PG_DATABASE:-ai4eemsdb}
      POSTGRES_USER: ${PG_USER:-ai4eemsuser}
      POSTGRES_PASSWORD: ${PG_PASSWORD:-124356987}
      TZ: Asia/Shanghai # 设置时区
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
```
