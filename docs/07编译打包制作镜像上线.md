# 07 编译打包制作镜像上线

本阶段是项目开发流程的收尾工作，目标是将 Go-Zero 服务编译成高效、轻量级的二进制文件，并使用 Docker 多阶段构建（Multi-stage Build）创建最小化的容器镜像，以便部署上线。

## 核心策略：多阶段构建

我们使用 **多阶段构建** 来实现：

1.  **第一阶段 (`go-builder`)：** 使用完整的 Golang 环境进行依赖下载和二进制编译。
2.  **第二阶段 (`alpine`)：** 使用极简的 Alpine 基础镜像，只复制编译好的二进制文件和配置文件，大幅减小镜像体积。

## 1\. Dockerfile 内容

以下是针对我们 `system-api` 服务的 Dockerfile。请注意，我们假设 `system-api` 的根目录在项目的 `./service/system/api` 下，并且最终可执行文件名为 `system-api`。

```dockerfile
# ----------------------------------------------------
# 第一阶段：编译 (Builder Stage)
# ----------------------------------------------------
FROM golang:1.23-alpine3.20 AS go-builder

# 设置工作目录为项目根目录
WORKDIR /Ai4EEMS-go

# 复制整个项目源码（假设Ai4EEMS-go是项目根目录）
COPY . .

# 启用 Go Modules 代理，下载依赖并整理
RUN go mod download && go mod tidy

# 进入 system-api 服务的 cmd 目录进行编译
# 注意：路径需要根据goctl生成的实际结构调整
WORKDIR /Ai4EEMS-go/service/system/api
# 编译二进制文件，并输出到根目录，命名为 system-api
RUN go build -o /system-api ./systemapi.go 

# ----------------------------------------------------
# 第二阶段：运行环境 (Final Stage)
# ----------------------------------------------------
FROM alpine:3.20

# 设置容器内工作目录
WORKDIR /app

# 复制第一阶段编译好的二进制文件
COPY --from=go-builder /system-api /app/

# 复制配置文件目录
# Go-Zero 配置文件通常位于 service/system/api/etc 
COPY --from=go-builder /Ai4EEMS-go/service/system/api/etc /app/etc

# 暴露服务端口 (默认为 8888 或配置文件中设置的端口)
EXPOSE 8888

# 容器启动时执行编译好的二进制文件
ENTRYPOINT ["/app/system-api"]
```

## 2\. 编译镜像并运行

在包含 `Dockerfile` 的项目根目录下执行以下命令：

### 步骤 1: 构建 Docker 镜像

使用 `docker build` 命令构建镜像，通常命名为 `ai4eems/system-api`。

```bash
docker build -t ai4eems/system-api:v1.0 .
```

### 步骤 2: 运行容器

使用 `docker run` 命令启动容器，将容器端口映射到宿主机端口（例如 8080）。

```bash
docker run -d --name system-api -p 8080:8888 ai4eems/system-api:v1.0
```

至此，Go-Zero 服务已经成功编译、打包并作为 Docker 容器运行起来，可以进行 API 网关配置（如 APISIX）和功能测试了。